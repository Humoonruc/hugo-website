---
title: "管道操作和用函数替代操作符"
subtitle: "magrittr 包"
author: "Humoon"
date: "`r Sys.Date()`"
output:
  html_document: 
    code_download: true
    fig_caption: yes
    theme: united
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
documentclass: ctexart
classoption: hyperref,
---
```{css, echo=FALSE}
/* 全局 */

body {
    font-size: 17px;
    color: #333333;
    font-family: 'Times New Roman', 'Microsoft YaHei';
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}


/* 多级标题 */

h1 {
    font-size: 32px;
    margin-top: 1em;
    margin-bottom: 1em;
    color: red;
    /* font-family: "Italic", STKaiTi; */
    font-weight: bold;
}

h2 {
    font-size: 28px;
    margin-top: 1em;
    margin-bottom: 1em;
    color: purple;
    /* font-family: KaiTi, "Italic", STKaiTi; */
    font-weight: bold;
}

h3 {
    color: darkslateblue;
    font-size: 24px;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

h4 {
    font-size: 20px;
}

h1.title,
h3.subtitle,
h4.author,
h4.date {
    text-align: center;
    margin-top: 0.5em;
    margin-bottom: 0em;
}


/* 代码 */

code,
.md-fences {
    color: darkred;
    font-family: Consolas;
}


/* 列表项 */

ul,
ol {
    margin: 0 0 1.5em 0.5em;
}

h3+ul,
h4+ul,
h5+ul,
h6+ul,
h3+ol,
h4+ol,
h5+ol,
h6+ol {
    margin-top: 0.5em;
}

p+ul,
p+ol {
    margin-top: 0.5em;
}

li>ul,
li>ol {
    margin-top: inherit;
    margin-bottom: 0;
    margin-left: 0.5em;
}

ul>li {
    list-style-type: disc;
    list-style-position: outside;
}

li ul>li {
    list-style-type: circle;
}

ol>li {
    list-style-type: decimal;
    list-style-position: outside;
}

li ol>li {
    list-style-type: upper-alpha;
}

li li ol>li {
    list-style-type: lower-greek;
}


/* 首行缩进 */

p {
    text-indent: 2em;
}


/* 表格 */

table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

table tr:nth-child(2n),
thead {
    background-color: #fafafa;
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}
```



```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 6, fig.asp = 0.618,
  out.width = "70%",fig.align = "center",
  fig.path = 'Figs/',fig.show = "hold",
  warning = FALSE, message = FALSE, echo = TRUE, 
  comment = '',
  cache = T, cache.comments = F, autodep = TRUE,
  options(digits = 4))
```

```{r setup, include=FALSE}
# use necessary packages
library('pacman')
p_load(tidyverse,readxl,lubridate,reshape2,magrittr,
       ggthemes,gridExtra,RColorBrewer,
       lmtest, xtable, flextable, officer, DT, RODBC,
       bookdown, bookdownplus, 
       XML, xml2, rvest, rlist)

pdf.options(family = "GB1") 
# 最后一个参数可以使pdf支持含中文的图片。
```


本文用到的脚本和数据下载：

```{r, echo=FALSE}
# 将数据和r脚本文件嵌入html
# xfun::embed_file('test.r')
```

```{r, echo=FALSE}
# xfun::embed_file('aaa.csv')
```


# 基本应用

把前一个表达式（函数）的输出直接传递给后面的函数或者表达式，省去不必要中间变量或者括号,使代码更加清晰易读。

一个标准：一行只做一件事，尽量少定义变量！

## `%>%` 管道操作符

传递结果给右边的函数或表达式

![](Figs/%E7%AE%A1%E9%81%93%E6%93%8D%E4%BD%9C%E7%AC%A6.png)

```{r}
set.seed(123)
rnorm(10) %>% `*`(5) %>% `+`(5) # `*`和`+`就像两个函数
```

## `%T>%` T 管道操作符

必须与`%>%`配合使用。

![](Figs/T%E7%AE%A1%E9%81%93%E6%93%8D%E4%BD%9C%E7%AC%A6.png)

例1：在数据处理的中间过程，需要打印输出或图片输出（如观察代码是否达到了预设的目的），这时整个过程就会被中断，用向左操作符就可以解决这样的问题。

```{r}
rnorm(100) %>% 
  matrix(ncol = 2) %T>% 
  plot() %>% 
  str()
```

## `%$%` 爆炸操作符

一些基础函数只接受向量作为参数，而不接受数据框，爆炸操作符可以将参数中的\$提取出来，让右侧的函数可以直接使用列名操作数据

```{r}
mtcars %$% cor(disp, mpg)
```

相当于

```{r}
cor(mtcars$disp, mtcars$mpg)
```

## `%<>%` 复合赋值操作符

功能与`%>%`基本一样，多了一项额外的操作，就是把结果写到左侧对象。比如，我们需要对一个数据集进行排序，同时需要获得排序的结果，用`%<>%`就是非常方便的。

现实原理如下图所示，使用`%<>%`把左侧的数据集A传递右侧的B函数，B函数的结果数据集再向右侧传递给C函数，C函数结果的数据集再重新赋值给A，完成整个过程。

![](Figs/%E5%A4%8D%E5%90%88%E8%B5%8B%E5%80%BC%E6%93%8D%E4%BD%9C%E7%AC%A6.png)

例：定义符合正态分布的100个随机数，计算绝对值，并按从小到大的顺序排序，获得并取前10个数字赋值给x。

```{r}
set.seed(1)
x <- rnorm(100)
a <- x %>% abs %>% sort %>% head(10)
a
x %<>% abs %>% sort %>% head(10)
x
```

`%<>%`的主要作用是省略一步`<-`，但会造成变量的改变，程序的健壮性会因此削弱，如果不是中间变量已经太多不想再命名中间变量，最好不要用。

# 扩展功能

## 用函数代替操作符

| 新函数                 | 原操作符       |
|------------------------|----------------|
| `extract()`        | `[`            |
| `extract2()`       | `[[`           |
| `inset()`          | `[<-`          |
| `inset2()`         | `[[<-`         |
| `set_colnames()`   | `colnames()<-` |
| `set_rownames()`   | `rownames()<-` |
| use_series             | `$`            |
| add                    | `+`            |
| subtract               | `-`            |
| multiply_by            | `*`            |
| raise_to_power         | `^`            |
| multiply_by_matrix     | `%*%`          |
| divide_by              | `/`            |
| divide_by_int          | `%/%`          |
| mod                    | `%%`           |
| is_in                  | `%in%`         |
| and                    | `&`            |
| or                     | `|`            |
| equals                 | `==`           |
| is_greater_than        | `>`            |
| is_weakly_greater_than | `>=`           |
| is_less_than           | `<`            |
| is_weakly_less_than    | `<=`           |
| not                    | `!`            |
| set_names              | `names()<-`    |

```{r}
set.seed(1)
x <- rnorm(10)
x
x %>% multiply_by(5) %>% add(5) # 替代`*`和`+`

x %<>% set_names(letters[1:10]) # 替代names(x) <- 
x

y <- list(c(1,2), c('a','b'))
y %>% `[`(2) 
# 不能直接用extract()，已被其他包同名函数覆盖
y %>% magrittr::extract(2) 
y %>% extract2(2)
y %>% extract2(2) %>% extract2(2)
y %>% map(extract2, 2) %>% unlist()

df <- tibble(v1 = 1:26, v2 = letters)
DT::datatable(df)
# 完成了列名赋值工作
df %<>% set_colnames(c('id','name')) %>% 
  filter(id %>% is_in(1:10)) # 替代 %in%
DT::datatable(df)
```

## 用 `%>%` 传递参数到代码块`{}`完成比较复杂的操作

例：对一个包括10个随机数的向量的先\*5再+5，求出向量的均值和标准差，并从小到大排序后返回前5条。

```{r}
set.seed(1)

rnorm(10) %>% multiply_by(5) %>% add(5) %>% 
  { 
    cat("Mean:", mean(.), "\nVar:", var(.), "\n") 
    sort(.) %>% head()
  }
```

## `%>%`传递到未定义的函数

函数`function(parameter){...}`外面还要用括号`()`括起来

```{r}
iris %>% (function(x) { 
  if (nrow(x) > 2) 
    bind_rows(head(x, 1), tail(x, 1)) %>% return()
  else x %>% return()
}) %>% DT::datatable()
```