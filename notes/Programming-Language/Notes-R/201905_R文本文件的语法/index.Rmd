---
title: "R文本文件的语法"
subtitle: 'Use R!'
author: "黄蒙, GSCASS"
date: "`r Sys.Date()`"
abstract: |
  随着近年来R语言相关环境的功能越来越丰富，编写包含R代码的文本文件，再通过统一的R环境运算、编译和导出，成为了一种管理文件的新方法。这种方法的好处有：（1）节省了硬盘资源，使多种多样的文件都能以文本的方式保存；（2）使针对原始数据所做的一切整理和分析工作变得可复制，实践了“可重复性研究”的理念；（3）能让作者专注于文件内容和参数调整本身，而把调节格式、修改结果的工作全部交给R并实现自动化。本文通过对markdown、Rmarkdown和bookdown的语法的整理，便利了R文本文件的编写。
site: bookdown::bookdown_site
documentclass: article
bibliography: [mybib.bib]
biblio-style: apalike
csl: china-journal-of-economic-research.csl
link-citations: yes
output: 
  bookdown::word_document2:
    reference_docx: template.docx
    toc: yes
  bookdown::epub_book: default
  bookdown::gitbook:
    includes:
      in_header: _header.html
    config:
      download: ["pdf",'epub']
      edit: null
      fontsettings:
        family: sans
        size: 2
        theme: sepia
      search: no
      toc:
        after: '编写：黄蒙'
        before: 'R文本文件的语法'
    split_by: chapter
  bookdown::html_document2:
    code_folding: show
    df_print: paged
    fig_caption: yes
    highlight: haddock
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: no
  bookdown::pdf_book:
    includes:
      in_header: preamble.tex
    latex_engine: xelatex
    citation_package: natbib
    keep_tex: yes
language:
  label:
    thm: '定理'
    def: '定义'
    exm: '例'
    proof: '证明: '
    solution: '解: '
    fig: '图'
    tab: '表'
  ui:
    chapter_name: ''
delete_merged_file: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 6, fig.asp = 0.618,
  out.width = "80%",fig.align = "center",
  fig.path = 'Figs/',fig.show = "hold",
  warning = FALSE, message = FALSE, echo = TRUE, 
  comment = '', collapse = F, 
  cache = T, cache.comments = F, autodep = TRUE,
  options(digits = 4, scipen = 4, signif = 4)
  )
```

```{r setup, include=FALSE}
# use necessary packages
library('pacman')
p_load(tidyverse, lubridate, reshape2, # 数据整理
       ggthemes, showtext, gridExtra, RColorBrewer, # 可视化
       lmtest, plm, orcutt, stats, forecast, # 统计分析  
       rvest, rlist, # 爬虫
       readxl, RMySQL, DT # I/O
       )

# pdf中图形中文设置
windowsFonts(H = windowsFont("微软雅黑"))
pdf.options(family = "GB1") 
# 代码块需要fig.showtext=TRUE选项，ggplot2图形再加一行 + theme(text = element_text(family = 'H'))来定义字体，才能正常显示图中的中文。

# 自定义主题
mytheme <- theme_economist_white() +
  theme(text = element_text(family = 'H'), # 所有的文本字体
        plot.title = element_text(face = 'bold'), 
        plot.caption = element_text(face = 'italic', hjust = 0),
        legend.title = element_text(size = 12, face = 'bold'),
        legend.text = element_text(size = 10),
        legend.position = 'right')
```




# 首要参考文献 {-}

[*R Markdown: The Definitive Guide*](https://bookdown.org/yihui/rmarkdown/)

# html 语法

html 语法大都可以在Rmarkdown中使用

## 文字颜色

代码：`<font color='blue'> 蓝色文字。 </font>`

效果：<font color='blue'> 蓝色文字。 </font>

## 字号

代码：`<font size = 4> 4号字。</font> <font size = 6> 6号字。</font>`

效果：<font size = 4> 4 号字。</font> <font size = 6> 6 号字。</font>

## 图片

代码：`<center><img src="地址" width = "50%" height = '100'... /><center/>`

代码：`<div align = center> <img src="地址" ... /> </div>`

效果：

<center><img src="https://static.runoob.com/images/runoob-logo.png" width = "50%" height = '100'/></center>

<div align = center> <img src="https://static.runoob.com/images/runoob-logo.png"/> </div>

# markdown基本语法 {#markdown}

## 段内换行

行末`<br/>`或两个以上空格 + 回车为段内换行，连续两个回车为新起一段

我是第一段第一行  
我是第一段第二行

我是第二段，注意正常的行间距和段间距

## 增加段间距

用`<br/>`，每多一个就多一次换行；或`&nbsp;`，表示一个空段落。

正常段间距

正常段间距<br/><br/>
连续两次换行，虽然看上去行距很大，但仍在一段中

&nbsp;

中间隔了一个空段落，空段落可以叠加

## 注释

用`<!--  -->`括住的内容会被注释掉，不显示在最终输出中。

## 引用

在引用中可以使用其他 Markdown 语法

### 单层和嵌套引用

> 张三说：李四这样说过

>> 不想当将军的木匠不是好厨子。

### 多行引用

仍然是一段（推荐）：

> 第一行  
> 第二行  

> 第一行
> 
> 第二行

变成了两段（不推荐）：

> 第一段

> 第二段

## 分隔线

三个以上的`*/-/_`

---

## 链接

### 直接表示：

格式为`<地址>`或`地址`(仅限 http 和 www 开头，这是 GFM 扩展语法)。如：百度的网址是 <http://www.baidu.com> 或 www.baidu.com，我的邮箱是 <humoonruc@126.com>。

### 行内链接

格式为`[链接名](地址)`。如：点击超链接[百度](http://www.baidu.com)

### 引用式链接

当链接被重复使用时，最好使用引用链接形式。可以将链接标记理解为一个地址变量。

在某处（比如文章结尾）定义一些链接标识符，语法为：`[链接标识符]:网址`。定义语句不会显示在输出中。正文中使用时，语法为：`[链接名][链接标识符]`，如：

在[ Google 首页][Google]查询 IT 资料通常是第一步，虽然在中文搜索方面[这个国际巨头][Google]的用户体验常常不如[百度](https://www.baidu.com)。

[Google]: https://www.google.com.hk

## 图片

1. 行内图片：    
`![图片名称]("图片地址或网址")`
不建议使用这种方法，编译pdf有时会报错。

2. 引用式图片：与链接类似，也可以在文章某处定义图片的标识符，然后把行内图片引用中图片地址替换成图片标识符即可。

## 列表

### 列表嵌套

用`Tab`缩进表示下一级

- 第一级
  - 第二级
    - 第三级
    - 第三级
  - 第二级

### 列表缩进

若列表项无换行，一个空格即可；若列表项有换行，建议无序列表用三个空格如`-   xxx`，有序列表用两个空格如`1.  xxx`

-   这个列表项  
    有换行
-   这个没有

1.  这个有序列表项  
    有换行
2.  这个没有

### 列表项间空行

无换行的列表项之间不建议空行；有换行的列表项之间建议空一行；列表开始和末尾都空一行

无换行：

- 抽烟
- 喝酒
- 烫头

有换行：

-   抽很多的  
    烟

-   喝酒

-   烫头

## 任务列表

**2019年读书计划**

- [x] 《R in Action》
- [x] 《R for Data Science》 
- [ ] 《Python 疯狂讲义》

## 管道表

Table:(\#tab:easytable) 管道表

Tables|Are|Cool
------------- |:-------------:| -----:
col 3 is| right-aligned | $1600
 col 2 is| centered|$12 
 zebra stripes| are neat|$1 

注：

1. 英文冒号 : 使列获得了某种对齐方式。
2. 代码块和引用块不能插入表格。
3. 管道表不允许输入单元格换行，单元格内容太宽时转换结果可能自动换行。
4. `Table: (\#tab:label) text`，为markdown简易表自动加表编号和表名(text)，写在简易表的前后均可。

# R Markdown语法{#Rmarkdown}

## 基本语法

* 删除线 `a~~b~~` 他是个~~天才~~疯子。
* 上标 `text^supscript^` a^2^
* 下标 `text~subscript~` k~1~
* 添加脚注 `text^[footnote] ` 某观点^[文献题录。] 

```{right, type="flushright", html.tag="p"}
代码块设置，使块中文字右对齐，仅适用于 pdf
```

## R代码块

行内代码如：`r Sys.Date()`  

```{python}
def print_name():
    print("Markdown")
```

代码块
```{r}
sin(pi/2)
```

## R表格

表格尽量使用代码块，便于统一编号
```{r}
table <- tibble::tibble(ID = 1:5, name = letters[1:5])
knitr::kable(table, caption = 'order of letters')
```

## R图

插图全部使用代码块，便于统一编号
```{r img1, fig.cap='xx图'}
# knitr::include_graphics("figs/myfig01.png")
```

## 公式
* 行内公式：将公式包在`$ $`之间，如：$\sin\pi/2=$ `r sin(pi/2)`  
* 独立公式：将公式包含在`$$ $$`之间，如：

$$
  f(x)=\frac{1}{2} \sum_{j=1}^{\infty} \int_{0}^{1} \sin ^{2}(j t x) d t
$$

* 为了产生对齐的公式，在独立公式中使用aligned环境。公式中的环境以`\begin{环境名}`开始，以`\end{环境名}`结束，用`\\`表示换行，用`&`表示一个上下对齐位置。如：

$$
\begin{aligned}
  f(x) =& \sum_{k=0}^\infty \frac{1}{k!} x^k \\
  =& e^x
\end{aligned}
$$

* 为公式手动编号
$$
  y = f(x) \tag{label}
$$

显然，手动编号不是一个好主意。

## 制表式截面 {.tabset}

仅适用于html格式

### By Product

(tab content)

### By Region

(tab content)


# bookdown语法{#bookdown}

bookdown比Rmarkdown的主要升级之处在于自动编号和交叉引用。

## 章节编号和引用

### 编号
`# (PART) 第一篇 {-}` 部分（篇）
`# References {-}` 参考文献
`# (APPENDIX) 附录 {-}` 附录 

### 引用
1. `{#tag}`,自动为标题编号，并定义标题的标签，便于引用。标签只能含字母、数字和连字符"-"，图、表标签同
2. `{-}`,不为标题编号，也不定义标签
3. `{#tag .unnumbered}`,设置标题的标签，但不为标题编号
4. `\@ref(tag)`,引用标题编号。如第\@ref(bookdown)节是关于bookdown的。


## 图形自动编号 {#usage-writing-fig}

用R代码块生成的图形，只要具有代码块标签label，且提供代码段选项`fig.cap="图题"`，就可对图形自动编号，并且可以用如`\@ref(fig:label)`的格式引用图形。如：

```{r u-w-f-ex01, fig.cap="测试图"}
plot(1:10)
```

引用如：参见图\@ref(fig:u-w-f-ex01)，其中的`fig:`是必须的。


## 表格自动编号 {#usage-writing-tab}

用R代码`knitr::kable()`生成的表格，只要具有代码块标签，并且在`knitr::kable()`调用时加选项`caption="表题"`，就可以对表格自动编号，并且可以用如`\@ref(tab:label)`的格式引用表格。如：

```{r u-w-tab-ex01}
d <- data.frame("自变量" = 1:10, "因变量" = (1:10)^2)
knitr::kable(d, caption = "1到10的平方", longtable = TRUE )
```

引用如：参见表\@ref(tab:u-w-tab-ex01)，其中的`tab:`是必须的。


## 数学公式编号 {#usage-writing-math}

不需要编号的公式，仍可以按照一般的Rmd文件使用行内的`$ $`或独立的`$$ $$`公式块。

需要编号的公式，写在`\begin{align}`和`\end{align}`之间。然后，对不需要编号的**行**在末尾用`\nonumber`标注；对需要编号的**行**用`(\#eq:mylabel)`添加自定义标签，在正文的引用中使用与上面相同的格式`\@ref(eq:mylable)`。如：

\begin{align}
f(x) =& \sum_{k=0}^\infty \frac{1}{k!} x^k (\#eq:efunc-sum) \\
  = e^x (\#eq:efunc-ex)
\end{align}


\begin{align}
\Sigma =&  (\sigma_{ij})_{n\times n} \nonumber \\
=& E[(\boldsymbol{X} - \boldsymbol{\mu}) (\boldsymbol{X} - \boldsymbol{\mu})^T ] (\#eq:var-mat-def)
\end{align}

引用如：协方差定义见式\@ref(eq:var-mat-def)。


## 文献引用与文献列表

1. 将所有文献用bib格式保存为一个`.bib`文献库，如模板中的样例文件`mybib.bib`。用`@item`和`[@item]`引用文献题录，如^[没有方括号时，题录前后一定要加空格。]:

源代码|效果
---|---
` @MWP06-HighStat `|@MWP06-HighStat
`@Lin2018 [page. 33]`|@Lin2018 [page. 33]
`[@Lin2018, page. 33]`|[@Lin2018, page. 33]
`[@Lin2018; @MWP06-HighStat]`|[@Lin2018; @MWP06-HighStat]
`[see @Lin2018, page. 33-35; also @MWP06-HighStat, ch. 1]`|[see @Lin2018, page. 33-35; also @MWP06-HighStat, ch. 1]
`[-@Lin2018]`|[-@Lin2018]

2. 将
```
nocite:|
@item1,@item2
```
写在YAML文件头中，表示某些文献不直接引用，只在末尾参考文献列表中出现。

被引用的文献将出现在一章末尾以及全书的末尾，对PDF输出则仅出现在全书末尾。

## 索引

`\index{索引词汇}`，标记为索引，仅适用于pdf格式，输出在文末。

## 编译

`bookdown::render_book('index.Rmd', 'bookdown::epub_book')`

`bookdown::render_book('index.Rmd', 'bookdown::pdf_book')`

`bookdown::render_book('index.Rmd', 'bookdown::gitbook')`

只编译一章：    
`bookdown::render_book('chapter1.rmd', 'bookdown::gitbook', preview = T)`

`r if (knitr::is_html_output()) '# 参考文献 {-}'`