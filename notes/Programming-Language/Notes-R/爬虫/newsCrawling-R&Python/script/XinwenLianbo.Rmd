---
title: "爬取新闻联播每日摘要"
subtitle: ''
author: "Humoon"
date: "`r Sys.Date()`"
output:
  html_document: 
    code_download: true
    fig_caption: yes
    theme: united
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  rticles::ctex:
    df_print: default
    fig_caption: yes
    number_sections: false
  word_document:
    fig_caption: yes
    toc: yes
    toc_depth: 3
    reference_docx: 
  pdf_document: 
    toc: yes
    toc_depth: 2
    latex_engine: xelatex
documentclass: ctexart
classoption: hyperref,
---

```{css, echo=FALSE}
/* 还可以在 yaml 头部加入 css:"style.css" 来使用外部css文件 */
  
  
/* 全局 */

body {
    font-size: 16px;
    color: #333333;
    font-family: sans-serif, 'Segoe UI', Tahoma, Geneva, Verdana, SimSun;
}

p,
blockquote,
ul,
ol,
dl,
table {
    margin: 0.8em 0;
}


/* 多级标题 */

h1 {
    font-size: 32px;
    margin-top: 1em;
    margin-bottom: 1em;
    color: red;
    font-weight: bold;
}

h2 {
    font-size: 28px;
    margin-top: 1em;
    margin-bottom: 1em;
    color: purple;
    font-weight: bold;
}

h3 {
    color: darkslateblue;
    font-size: 24px;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

h4 {
    font-size: 20px;
}

h1.title,
h3.subtitle,
h4.author,
h4.date {
    margin-top: 0.5em;
    margin-bottom: 0em;
}

h4.date {
  margin-bottom: 2em;
}

/* 链接 */

a {
  color: blue;
}

/* 代码 */

code,
.md-fences {
  color: darkred;
  font-family: Courier;
  font-weight: bold;
}

div.sourceCode code {
  font-size: 14px;
  color: black;
  font-family: Consolas;
  font-weight: normal;
}

div.sourceCode code.sourceCode span.fu {
  color: #F75000;
}

div.sourceCode code.sourceCode span.sc {
  color: blue;
}

div.sourceCode code.sourceCode span.st {
  color: green;
}

div.sourceCode code.sourceCode span.co {
  color: grey;
}

div.sourceCode code.sourceCode span.dv {
  color: BlueViolet;
}

div.sourceCode code.sourceCode span.cn {
  color: darkcyan;
}

div.sourceCode code.sourceCode span.at {
  color: royalblue;
}

/* 粗体 */
strong {
  font-family: 'Microsoft YaHei';
}

/* 列表项 */

ul,
ol {
    margin: 0 0 1.5em 0.5em;
}

h3+ul,
h4+ul,
h5+ul,
h6+ul,
h3+ol,
h4+ol,
h5+ol,
h6+ol {
    margin-top: 0.5em;
}

p+ul,
p+ol {
    margin-top: 0.5em;
}

li>ul,
li>ol {
    margin-top: inherit;
    margin-bottom: 0;
    margin-left: 0.5em;
}

ul>li {
    list-style-type: disc;
    list-style-position: outside;
}

li ul>li {
    list-style-type: circle;
}

ol>li {
    list-style-type: decimal;
    list-style-position: outside;
}

li ol>li {
    list-style-type: upper-alpha;
}

li li ol>li {
    list-style-type: lower-greek;
}


/* 首行缩进 */

p {
    text-indent: 0em;
}


/* 表格 */
  
div.pagedtable{
  font-size:12px;
}

table {
    padding: 0;
    word-break: initial;
}

table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}

table tr:nth-child(2n),
thead {
    background-color: #fafafa;
}

table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr td {
    border: 1px solid #dfe2e5;
    text-align: left;
    margin: 0;
    padding: 6px 13px;
}

table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}

table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}


/* 侧边栏 */
div.col-lg-3 {
  width: 25%;
  max-width: 250px;
}

div.tocify {
  width: 20%;
  max-width: 200px;
  max-height: 90%;
  font-size: 16px;
}

div.toc-content {
  padding-left: 0px;
  padding-right: 40px;
}
```

```{r setup, include = FALSE}
## global options
knitr::opts_chunk$set(
  fig.width = 7,
  fig.asp = 0.618,
  out.width = "90%",
  fig.align = "center",
  fig.path = 'Figures/',
  fig.show = "hold",
  warn = 1,
  warning = FALSE,
  message = FALSE,
  echo = TRUE, # 是否显示代码
  eval = TRUE, # 是否运行代码块
  tidy = TRUE, # 代码排版
  comment = '#',
  collapse = F, # 代码与结果是否显示在同一代码块
  cache = T,
  cache.comments = F,
  autodep = TRUE
)

## use necessary packages
library('pacman')
p_load(
  # data processing
  tidyverse, lubridate, data.table, magrittr,
  # visualization
  ggthemes, showtext, gridExtra, r2d3, 
  # 可交互表格 DT::datatable()
  DT,
  # I/O 
  sqldf, jsonlite,
  # web crawler
  rvest, httr, reticulate
  )

## database engine
options(sqldf.driver = "SQLite")

# d3绘图的前景色和背景色
options(r2d3.theme = list(background = "white", foreground = "royalblack"))

## plotting
# 包含图的代码块需要fig.showtext = TRUE选项
showtext_auto(enable = TRUE)
# ggplot2图形需要在主题中显式指定中文字体才能正常显示图中的中文
windowsFonts(YaHei = windowsFont("Microsoft YaHei"))
# pdf中图形内部的中文字体设置
pdf.options(family = "GB1")

## 自定义图形主题
# common template
mytheme <- theme_economist_white() +
  theme(
    text = element_text(family = 'YaHei'),
    plot.title = element_text(face = 'bold', size = 14),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(
      hjust = 0,
      size = 10,
      margin = margin(2, 0, 0, 0, 'pt')
    ),
    plot.margin = margin(12, 10, 12, 0, 'pt'),
    legend.position = 'top',
    legend.justification = 'left',
    legend.margin = margin(4, 0, 0, 0, 'pt'),
    legend.key.size = unit(1, 'lines'),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10, margin = margin(0, 0, 0, 0, 'pt')),
    axis.text = element_text(size = 10, margin = margin(2, 0, 2, 0, 'pt')),
    axis.ticks.length = unit(-4, 'pt')
  )
# histogram template
theme_bar <- theme_economist_white() +
  theme(
    text = element_text(family = 'YaHei'),
    plot.title = element_text(face = 'bold', size = 14),
    plot.subtitle = element_text(size = 12),
    plot.caption = element_text(
      hjust = 0,
      size = 10,
      margin = margin(0, 0, 0, 0, 'pt')
    ),
    plot.margin = margin(12, 0, 12, 10, 'pt'),
    legend.position = 'top',
    legend.justification = 'left',
    legend.margin = margin(4, 0, 0, 0, 'pt'),
    legend.key.size = unit(0.7, 'lines'),
    legend.title = element_blank(),
    legend.text = element_text(size = 10, margin = margin(0, 8, 0, 4, 'pt')),
    axis.text = element_text(size = 10),
    axis.ticks.length = unit(0, 'pt') # 不要坐标轴须
  )
```


央视网根目录并无 robots.txt 文件，不限制任何爬虫，可以放心爬取。

# 调用封装好的爬虫函数

- 在 python 脚本`./getHTML.py`中定义了爬取Web页面的函数`getHTML()`。通过reticulate包的`py_run_file()`运行该脚本后，即可用`py$getHTML()`的方式调用该函数。

- 在 R 脚本`./crawlWebPageFunction.R`中定义了爬取Web页面的函数`getWebPage()`，用`source()`运行脚本后可直接调用。

使用任何一个函数均可。

```{r}
# py$getHTML()
reticulate::py_run_file("./getHTML.py") 
# getWebPage()
# 注意.Rmd文件中路径时相对于Rmd文件本身的，而.R文件中的路径是相对于项目的根目录的，这个区别很大
source('./crawlWebPageFunction.R') 
```


# 解析和整理单日数据

定义`getDailyNews()`，解析和整理新闻联播每日摘要

```{r}

getDailyNews <- function(date) {

  ## 1. 构建对摘要数据真实地址的请求
  url <- str_c("https://tv.cctv.com/lm/xwlb/day/", date, ".shtml")
  
  
  ## 2. 爬取摘要页的文本和链接信息
  rootNode <- getWebPage(url) %>% # 爬取，返回字符串
    read_html() %T>% # 解析为xml_document类
    write_html("successOrFail.html") # 写至本地，观察测试
  
  # 新闻标题
  titles <- rootNode %>% 
    html_nodes("div.title") %>% 
    html_text()
  
  # 详情链接
  links <- rootNode %>% 
    html_nodes("li>a") %>% 
    html_attrs() %>%
    map_chr(extract("href")) # 传给map_chr的是列表的各个元素

  
  ## 3. 用数据框的方式组织数据
  indexPage <-
    data.table(title = titles, link = links) %>%
    filter(str_detect(title, "[视频]")) %>%
    mutate(title = str_replace(title, "\\[视频\\]", "")) #若不转义会被理解为正则表达式
  indexPage[, id := 1:.N] # 增加一列编号
  # 或者写成: %>% rownames_to_column(var = "id") 
  
  # 国内联播快讯和国际联播快讯，需要进一步爬取具体内容
  domesticExpressLink <-
    indexPage[title == "国内联播快讯", link]
  foreignExpressLink <-
    indexPage[title == "国际联播快讯", link]
  
  
  ## 4. 跳转页面，爬取国内和国际联播快讯的具体条目
  if (length(domesticExpressLink) > 0) {
    domesticExpress <- domesticExpressLink %>%
      getWebPage() %>%
      read_html() %>%
      html_nodes("div.cnt_bd>p>strong") %>%
      html_text()
    
    domesticPage <- data.table(title = "国内联播快讯",
                               detail = domesticExpress) %>%
      filter(detail != "央视网消息" & detail != "") %>%
      inner_join(indexPage) %>%
      mutate(title = str_c("【国内联播快讯】", detail)) %>%
      select(-detail)
  } else{
    domesticPage <- data.table()
  }
  
  if (length(foreignExpressLink) > 0) {
    foreignExpress <- foreignExpressLink %>%
      getWebPage() %>%
      read_html() %>%
      html_nodes("div.cnt_bd>p>strong") %>%
      html_text()
    
    foreignPage <- data.table(title = "国际联播快讯",
                              detail = foreignExpress) %>%
      filter(detail != "央视网消息" & detail != "") %>%
      inner_join(indexPage) %>%
      mutate(title = str_c("【国际联播快讯】", detail)) %>%
      select(-detail)
  } else{
    foreignPage <- data.table()
  }
  
  
  ## 5. 表的合并
  newsTable <- bind_rows(indexPage, domesticPage, foreignPage) %>% 
    unique() %>% 
    arrange(id) %>%
    filter(!title %in% c("国内联播快讯", "国际联播快讯")) %>%
    mutate(
      date = ymd(date) %>% as.character(),
      year = year(ymd(date)),
      month = month(ymd(date)),
      day = day(ymd(date))
    ) %>%
    select(date, title, link, year, month, day)
  
  return(newsTable)
}
```

# 主函数

定义`main()`，根据提出的期限循环爬取多日数据，并将结果保存为表格

```{r}
main <- function(timeSpan){
  
  # 创建空数据框作为容器
  XinwenLianbo <- data.table()
  
  # 循环爬取
  for (i in 1:timeSpan) {
    date <- (today() - timeSpan - 1 + i) %>%
      format("%Y%m%d") # 日期格式化
    dailyNews <- getDailyNews(date)
    XinwenLianbo <-  bind_rows(XinwenLianbo, dailyNews)
    Sys.sleep(1)
  }
  
  startDate <- (today() - timeSpan) %>% format("%Y%m%d")
  endDate <- (today() - 1) %>% format("%Y%m%d")
  
  # 这个文件路径，.Rmd与.R不同
  filePath <-
    str_c("../data/XinwenLianbo-", startDate, "-", endDate, ".csv")
  
  # 防止中文乱码，只能用write_excel_csv()，且append必须为F
  write_excel_csv(XinwenLianbo, filePath)
}
```

# 提交配置并运行程序

给出爬取天数（从当天开始向前倒推），然后执行`main(timeSpan)`即可。

本脚本可以爬取2016年2月3日至今的全部新闻联播数据。再之前的页面格式与最近几年的不同，需要修改代码才能爬取。

```{r}
timeSpan <-  3
main(timeSpan)
```