---
title: "rvest包"
author: "Humoon"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    df_print: paged
    fig_caption: yes
    theme: united
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: no
  beamer_presentation:
    highlight: haddock
  pdf_document:
    toc: yes
    toc_depth: '3'
  slidy_presentation:
    highlight: haddock
  ioslides_presentation:
    highlight: haddock
---

```{r setup, include = FALSE}

## global options
knitr::opts_chunk$set(
  fig.width = 6, fig.asp = 0.618,
  out.width = "80%", fig.align = "center",
  fig.path = 'Figures/', fig.show = "hold",
  warn = 1, warning = FALSE, message = FALSE, echo = TRUE, 
  comment = '', collapse = F, 
  cache = T, cache.comments = F, autodep = TRUE
  )


## use necessary packages
library('pacman')
p_load(tidyverse, lubridate, data.table, magrittr, # 数据整理
       ggthemes, showtext, gridExtra, igraph, ggraph, # 可视化
       lmtest, plm, orcutt, stats, forecast, zoo, # 统计分析  
       rvest, httr, xml2, # 爬虫
       sqldf, DT, # I/O
       jiebaR, wordcloud2, webshot, htmlwidgets, tidytext # 文本分析
       )
options(sqldf.driver = "SQLite") 


## pdf中图形内部的中文字体设置
pdf.options(family = "GB1")
# 安装字体文件
# font_add('YaHei','MS YaHei.ttf')
windowsFonts(YaHei = windowsFont("Microsoft YaHei"))
showtext_auto(enable = TRUE)
# 包含图的代码块需要fig.showtext = TRUE选项
# ggplot2图形需要在主题中显式指定中文字体才能正常显示图中的中文


## 自定义一般图形主题
mytheme <- theme_economist_white() +
  theme(text = element_text(family = 'YaHei'),
        plot.title = element_text(face = 'bold', size = 14), 
        plot.subtitle = element_text(size = 12),
        plot.caption = element_text(hjust = 0, size = 10, margin = margin(2,0,0,0,'pt')),
        plot.margin = margin(12,10,12,0,'pt'),
        legend.position = 'top',
        legend.justification = 'left',
        legend.margin = margin(4,0,0,0,'pt'),
        legend.key.size = unit(1,'lines'),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10, margin = margin(0,0,0,0,'pt')),
        axis.text = element_text(size = 10, margin = margin(2,0,2,0,'pt')),
        axis.ticks.length = unit(-4,'pt')
        )

# 自定义柱状图主题
theme_bar <- theme_economist_white() +
  theme(text = element_text(family = 'YaHei'), # 所有的文本字体
        plot.title = element_text(face = 'bold', size = 14), 
        plot.subtitle = element_text(size = 12),
        plot.caption = element_text(hjust = 0, size = 10,
                                    margin = margin(0,0,0,0,'pt')),
        plot.margin = margin(12,0,12,10,'pt'),
        legend.position = 'top',
        legend.justification = 'left',
        legend.margin = margin(4,0,0,0,'pt'),
        legend.key.size = unit(0.7,'lines'),
        legend.title = element_blank(),
        legend.text = element_text(size = 10, margin = margin(0,8,0,4,'pt')),
        axis.text = element_text(size = 10),
        axis.ticks.length = unit(0,'pt') # 不要坐标轴须
        )
```

SelectorGadget 插件的使用方法：
```{r}
vignette("selectorgadget")
```


# rvest 包

## 基本函数

函数名|功能
--|--
`read_html()`|下载并根据 html 语言解析网页为 xml_document 类对象 
`html_tag()`|提取标签名称
`html_nodes()`|定位节点，返回一个仅包含节点信息的较小的list
`html_node()`|相当于对html_nodes()取[[1]]操作
`html_table()`|获取所有以table为标签的表格，返回数据框。默认参数trim = T，设置header = T可以包含表头
`html_text()`|提取节点属性文本信息，令参数trim = T,可以去除首尾的空格
`html_attrs()`|提取节点的属性，返回list
`html_children()`|提取某个节点的子节点

`html_*()`函数族可以接受css参数，传入一个css选择器；也可以接受xpath参数，但二者不能同时存在。

例1：抓取金州勇士队的球员数据
```{r}
url <- 'http://www.stat-nba.com/team/GSW.html'
table <- url %>% read_html() %>% html_table()
table[[1]]
table[[2]]
```

例2：BDI指数
```{r}
# url <- 'https://cn.investing.com/indices/baltic-dry-historical-data'
# url <- "http://www.customs.gov.cn/customs/302249/zfxxgk/2799825/302274/302275/3511730/index.html"
# 
# # 下载网页到本地，包括文字、表格，甚至广告
# download.file(url, "./temporary.html") 
# 
# # 解析网页，并读取网页中的表格
# table <- url %>% 
#   read_html(encoding = 'UTF-8') %>% 
#   html_table(header = T, fill = T) 
# 
# DT::datatable(table[[1]])
```

## 通过填写表单获取网址

函数名|功能
--|--
`html_session(url)`|在网页中创建会话
`html_form(session)`|提取出你所需要的表单
`set_values(form, name1=value1, name2=value2, ...)`|填写表单
`submit_form(session, form)`|提交表单，发送给服务器


```{r}
u <- "https://movie.douban.com/"
session <- html_session(u) # 创建会话
forms <- html_form(session) # 提取表单
forms # 查看表单
form <- forms[[1]] # forms 中的第一个列表是我们的目标列表
form
# 在上面的结果中，只有'search_text'的冒号后为空
# 这表明 ‘search_text’ 还没有填充任何值，而我们的任务就是把它填上
filled_form <- set_values(form, search_text = "流浪地球") # 填写表单
filled_form
session2 <- submit_form(session, form = filled_form) # 根据填写的表单，创建新会话
session2$url # 查看新会话的 url
url2 <- iconv(URLdecode(session2$url), "UTF8") # 获得重新编码的网址，用以爬虫
url2 %>% read_html() %>% write_html("successOrFail.html") # 未能成功抓取
```

# 对url编码和解码

URL是通过ASCII字符集来实现编码的，所有不在这个字符集中的字符和特殊字符串都需要转义编码为标准的表示法，URL编码也被称为百分号编码，因为每个这样的编码都是以“%”开头的。

```{r}
char = "Golden states worries is the NBA champion in 2017"
(charEncode = URLencode(char, reserved = T))
(charDecode = URLdecode(charEncode))
```


